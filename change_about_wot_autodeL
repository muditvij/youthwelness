
 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouthMind - AI Mental Health Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Add to your existing styles */
.modal-content {
    transition: all 0.3s ease-out;
}

.feature-item {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.social-link {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Smooth transitions for the notification */
.fixed {
    transition: all 0.3s ease-out;
}
        :root {
            --background: 240 5% 96%; /* gray-50 */
            --foreground: 240 10% 3.9%; /* gray-950 */
            --card: 0 0% 100%;
            --card-foreground: 240 10% 3.9%;
            --primary: 240 5.9% 10%;
            --primary-foreground: 0 0% 98%;
        }

        .dark {
             --background: 240 10% 3.9%;
             --foreground: 0 0% 98%;
             --card: 240 5.9% 10%;
             --card-foreground: 0 0% 98%;
             --primary: 0 0% 98%;
             --primary-foreground: 240 5.9% 10%;
        }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .slide-up { animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .scale-in { animation: scaleIn 0.7s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .typing-indicator span {
            animation: pulse 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .skeleton {
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 0.5rem;
            animation: pulse-bg 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .dark .skeleton { background-color: #374151; /* gray-700 */ }
        @keyframes pulse-bg {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .music-player-track {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .note-item.deleting {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .note-item {
            transition: all 0.3s ease;
        }
        .badge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        /* Base styles for modal and popup */
        .quiz-popup {
            animation: slideInUp 0.5s ease-out forwards, fadeOut 0.5s ease-in-out 14.5s forwards;
        }
         @keyframes breathe {
        0%, 100% { transform: scale(0.5); opacity: 0.2; }
        50% { transform: scale(1); opacity: 0.7; }
    }
/* Add to your existing styles */
.fixed {
    transition: all 0.3s ease-out;
}

.transform {
    transition: all 0.3s ease-out;
}

.translate-y-10 {
    transform: translateY(2.5rem);
}

.translate-y-0 {
    transform: translateY(0);
}

.opacity-0 {
    opacity: 0;
}

.opacity-100 {
    opacity: 1;
}
    .breathing-circle {
        animation: breathe 8s infinite ease-in-out;
    }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            animation: scaleIn 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Custom radio buttons */
        .custom-radio input[type="radio"] {
            display: none;
        }
        .custom-radio label {
            transition: all 0.2s ease-in-out;
        }
        .custom-radio input[type="radio"]:checked + label {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #e0e7ff; /* indigo-100 */
            color: #312e81; /* indigo-900 */
            font-weight: 600;
        }
        .dark .custom-radio input[type="radio"]:checked + label {
            border-color: #a78bfa; /* violet-400 */
            background-color: #4338ca; /* indigo-700 */
            color: #ffffff;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950">

    <div id="app-root">
        <!-- App will be rendered here -->
    </div>
 <div id="feature-container" class="fixed inset-0 z-50 pointer-events-none"></div>
    <script type="module">
        // Firebase Importsimport { 
   import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { 
    getAuth, 
    onAuthStateChanged, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    signOut, 
    updateProfile, 
    setPersistence, 
    browserLocalPersistence 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
    getFirestore, 
    doc, 
    getDoc, 
    setDoc, 
    serverTimestamp, 
    collection, 
    addDoc, 
    query, 
    orderBy, 
    onSnapshot, 
    updateDoc, 
    arrayUnion, 
    arrayRemove, 
    increment,
    where, 
    getDocs, 
    deleteDoc,
    Timestamp
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===== 1) Firebase & App State Initialization =====
        const appRoot = document.getElementById('app-root');
        let app, db, auth;
        let user = null;
        let profile = null;
        let todayMood = null;
        let calendarMap = {};
        let chartData = [];
        let chatMessages = [];
        let chatUnsubscribe = null;
        let isDarkMode = false; // Default to light mode
        let isBreathingExerciseActive = false;
        let breathCycleCount = 0;
const MAX_BREATH_CYCLES = 5;

        
        // ===== MUSIC CATEGORIES SECTION =====
        // Flexible track assignment system - easily customizable
        // Simply change the start and end numbers to assign different tracks to each mood
        // Example: "Very Sad": { start: 1, end: 20 } means tracks music1.mp3 to music20.mp3
        const MUSIC_TRACK_ASSIGNMENTS = {
            "Very Sad": {
                start: 1,
                end: 5,
                description: "Tracks 1-20 for very sad moods"
            },
            "Sad": {
                start: 6,
                end: 10,
                description: "Tracks 21-40 for sad moods"
            },
            "Neutral": {
                start: 11,
                end: 15,
                description: "Tracks 41-60 for neutral moods"
            },
            "Happy": {
                start: 16,
                end: 20,
                description: "Tracks 61-80 for happy moods"
            },
            "Very Happy": {
                start: 21,
                end: 25,
                description: "Tracks 81-100 for very happy moods"
            }
        };

        // Generate music categories based on track assignments
        const MUSIC_CATEGORIES = {};
        Object.keys(MUSIC_TRACK_ASSIGNMENTS).forEach(mood => {
            const assignment = MUSIC_TRACK_ASSIGNMENTS[mood];
            const tracks = [];
            for (let i = assignment.start; i <= assignment.end; i++) {
                tracks.push(`music${i}.mp3`);
            }
            MUSIC_CATEGORIES[mood] = tracks;
        });
        
        const musicPlaylist = Array.from({length: 20}, (_, i) => `music${i + 1}.mp3`);
        let shuffledPlaylist = [];
        let currentTrackIndex = 0;
        let isShuffled = true;
        let currentMusicCategory = "Neutral"; // Default category
        const audio = new Audio();


        // User's Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAbEOtxeAdvh-ZwXCbhH9VQDzWENx8FGB8",
          authDomain: "secret-whisper29.firebaseapp.com",
          projectId: "secret-whisper29",
          storageBucket: "secret-whisper29.firebasestorage.app",
          messagingSenderId: "430580076855",
          appId: "1:430580076855:web:78f1a095e18df3fa178ab2",
          measurementId: "G-WXJG06XQ2Y"
        };
        
        const appId = "default-app-id"; 

        // ===== 2) Helpers & Constants =====
        const MOODS = [
          { score: -2, label: "Very Sad", emoji: "ü•Ä", color: "#ef4444" },
          { score: -1, label: "Sad", emoji: "üåßÔ∏è", color: "#f97316" },
          { score: 0, label: "Neutral", emoji: "üå§Ô∏è", color: "#eab308" },
          { score: 1, label: "Happy", emoji: "üåà", color: "#22c55e" },
          { score: 2, label: "Very Happy", emoji: "‚ú®", color: "#8b5cf6" },
        ];

        const COUNSELORS = [
            { name: "Vaibhav Sharma", degree: "M.Phil, Clinical Psychology", experience: "8+ Years", whatsapp: "" },
            { name: "Madhav Kumar", degree: "M.Sc, Counseling Psychology", experience: "6+ Years", whatsapp: "918630044552" },
            { name: "Rahul Sharma", degree: "MA, Psychology", experience: "5+ Years", whatsapp: "917500683911" },
        ];
        
        // ===== VIDEO GENRE LINKS SECTION =====
        // Add your video links here for each genre
        const VIDEO_GENRES = {
            bollywood: [
                '9cFSILnHvoU', // Replace with actual Bollywood motivational video IDs
                'hXMjKVKO18g',
                '0zFoHrvbRu4'
            ],
            hollywood: [
                'GYvONHG9a14', // Replace with actual Hollywood motivational video IDs
                'TJPFYs_88-g',
                'ioeoCbDiMvE'
            ],
            sports: [
                'U7ZOFL68B8c', // Replace with actual sports motivational video IDs
                'lF9_UnA0ts0',
                'IqCwPU14U3A'
            ],
            random: [
                'U7ZOFL68B8c', // Replace with actual sports motivational video IDs
                'lF9_UnA0ts0',
                'IqCwPU14U3A',
                'GYvONHG9a14', // Replace with actual Hollywood motivational video IDs
                'TJPFYs_88-g',
                'ioeoCbDiMvE',
            'GwzN5YknM3U',
              '9cFSILnHvoU', // Replace with actual Bollywood motivational video IDs
                'hXMjKVKO18g',
                '0zFoHrvbRu4', // Replace with actual random motivational video IDs
                //'cPa_K_s2g24',
                //'z9bZufPH12A',
                //'Z21sEOF_2oI',
                //'5MgBikgcWnY'
            ]
        };
        
        const MOTIVATIONAL_VIDEOS = [//'dQw4w9WgXcQ', '3sK3wJAxGfs', 'mgmVOuLgFB0', 'I22gsk_Gj84', 'ZXsQAXx_ao0', 'g-jwWYX7Jlo', '6P2nPI6CTlc', 'ZXsQAXx_ao0', 'unxxS3ddI1c', 'k9zTr2MAi0g', 'GwzN5YknM3U', 'cPa_K_s2g24', 'z9bZufPH12A', 'Z21sEOF_2oI', '5MgBikgcWnY'
        // 'U7ZOFL68B8c', // Replace with actual sports motivational video IDs
                'lF9_UnA0ts0',
                'IqCwPU14U3A',
                'GYvONHG9a14', // Replace with actual Hollywood motivational video IDs
                'TJPFYs_88-g',
                'ioeoCbDiMvE',
            'GwzN5YknM3U',
              '9cFSILnHvoU', // Replace with actual Bollywood motivational video IDs
                'hXMjKVKO18g',
                '0zFoHrvbRu4',];
        
        // ===== EVENTS DATA SECTION =====
        // Add your events here
        const EVENTS_DATA = [
            {
                id: 1,
                title: "Mindfulness Meditation Session",
                date: "2024-01-15",
                time: "10:00 AM",
                description: "Join us for a guided meditation session to start your day with peace and clarity.",
                type: "wellness",
                location: "Online Zoom Meeting"
            },
            {
                id: 2,
                title: "Mental Health Awareness Workshop",
                date: "2024-01-20",
                time: "2:00 PM",
                description: "Learn about mental health, coping strategies, and how to support others.",
                type: "education",
                location: "Community Center"
            },
            {
                id: 3,
                title: "Stress Management Techniques",
                date: "2024-01-25",
                time: "6:00 PM",
                description: "Practical workshop on managing stress and building resilience.",
                type: "workshop",
                location: "Online"
            },
            {
                id: 4,
                title: "Peer Support Group Meeting",
                date: "2024-01-30",
                time: "7:00 PM",
                description: "Safe space to share experiences and connect with others on similar journeys.",
                type: "support",
                location: "Youth Center"
            }
        ];
        
        const GREETINGS = (name) => {
            const lines = [
                `Hello ${name}, ready to make today amazing? ‚ú®`,
                `Welcome back, ${name}! What's on your mind today?`,
                `Hey ${name}, let's check in and see how you're doing.`,
                `Glad to see you, ${name}! Remember, every day is a fresh start.`,
                `Hi ${name}! Wanna share something? I'm all ears. üéß`
            ];
            return lines[Math.floor(Math.random() * lines.length)];
        };


        function titleCase(s) {
          if (!s) return "";
          return s.replace(/\w\S*/g, (w) => w[0].toUpperCase() + w.slice(1).toLowerCase());
        }
        function dateId(d = new Date()) {
          const tz = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
          return tz.toISOString().slice(0, 10);
        }

        // ===== 3) Gemini API Logic =====
        async function generateReply({ text, moodScore, name, chatHistory }) {
            const GEMINI_API_KEY = "AIzaSyDgHqrrTXR8apwWUxJSomJgw-BODNFoC-E"; 
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            
            if (!GEMINI_API_KEY) {
                return { text: "The chatbot is not configured. Please add a Gemini API key to the code.", crisis: false };
            }

            const moodDescription = MOODS.find(m => m.score === moodScore)?.label || "feeling neutral";
            const systemPrompt = `You are YouthMind, a playful and supportive pocket buddy for young adults in India. Your vibe is chatty, funny, and full of warmth ‚Äî like a best friend who‚Äôs always ready to listen. You‚Äôre not a doctor, just a crazy-good listener who mixes empathy with jokes, hype, and desi vibes.

The user‚Äôs name is ${name || "Friend"}, and today they‚Äôre feeling ${moodDescription}.
Your replies should:

Be short and lively if the user shares something casual.

Expand into a descriptive but still engaging response (max 250‚Äì300 words) if the user‚Äôs input genuinely needs it.

Use emojis, humor, and curiosity to keep the convo flowing. Break long replies into short, readable chunks.

If the user hints at self-harm, depression, or overwhelming distress:

Pause the humor.

Switch to a mature, calm, and empathetic tone.

Offer comfort, remind them they‚Äôre not alone, and gently suggest reaching out to a trusted friend, family member, or professional.

Keep the language supportive and never judgmental. If user talk to you in hinglish then talk to user in hinglish.`;

            const payload = {
                contents: [ ...chatHistory, { role: 'user', parts: [{ text }] } ],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API Error: ${errorBody.error.message}`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                const botText = candidate?.content?.parts?.[0]?.text || "I'm not sure how to respond to that.";
                const crisisWords = ["suicide", "kill myself", "end it all", "self-harm", "cutting myself", "hopeless", "worthless", "no reason to live", "want to die", "better off dead", "end my life"];
                const isCrisis = crisisWords.some(w => text.toLowerCase().includes(w));
                
                return { 
                    text: isCrisis ? `Thank you for sharing that with me, ${name}. I'm hearing a lot of pain in your words, and I want you to know I'm here and listening. Your safety is the most important thing right now. If you're in immediate danger, please reach out to emergency services (like 112 in India) or a trusted adult. You're not alone in this. Sometimes just taking a moment to breathe can help. Can we try taking one slow, deep breath together? Inhale... and exhale.<b> check below you can talk to our counncellors, if feeling not good.` : botText,
                    crisis: isCrisis
                };
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return { text: "Sorry, I couldn't connect right now. Let's try again in a bit.", crisis: false };
            }
        }

        // ===== 4) Render Functions =====
        function renderLoadingScreen() {
            appRoot.innerHTML = `
                <div class="min-h-screen grid place-items-center bg-gradient-to-br from-indigo-50 to-rose-50 dark:from-gray-900 dark:to-gray-950 p-4">
                    <div class="text-center space-y-3 scale-in">
                        <div class="flex justify-center items-center text-3xl font-bold text-gray-800 dark:text-gray-200 gap-3">
                           <svg class="w-10 h-10 text-indigo-500" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16.5 16.5H14.5L12 13.25L9.5 16.5H7.5L11 12.25V7.5H13V12.25L16.5 16.5Z"/>
                            </svg>
                            <span class="text-4xl">YouthMind</span>
                        </div>
                        <div class="flex justify-center pt-2">
                            <div class="w-8 h-8 border-4 border-t-transparent border-indigo-500 rounded-full animate-spin"></div>
                        </div>
                    </div>
                </div>`;
        }
        
        function renderAuthCard(error = "", notice = "", loading = false) {
             appRoot.innerHTML = `<div class="min-h-screen grid place-items-center bg-gradient-to-br from-indigo-50 via-white to-rose-50 dark:from-gray-900 dark:via-gray-950 dark:to-gray-900 p-4"><div id="auth-card" class="max-w-md w-full mx-auto bg-white/70 dark:bg-gray-800/70 backdrop-blur-xl rounded-2xl shadow-lg p-6 sm:p-8 space-y-6 fade-in"><div class="text-center"><div class="inline-flex items-center justify-center gap-3"><svg class="w-9 h-9 text-indigo-500" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16.5 16.5H14.5L12 13.25L9.5 16.5H7.5L11 12.25V7.5H13V12.25L16.5 16.5Z"/></svg><h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">YouthMind</h1></div><p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-2">Your friendly pocket counsellor üí¨</p></div><div class="flex justify-center gap-2 text-sm"><button id="mode-signin" class="px-4 py-1.5 rounded-full font-semibold transition-all bg-indigo-600 dark:bg-indigo-500 text-white shadow-sm">Sign in</button><button id="mode-signup" class="px-4 py-1.5 rounded-full font-semibold transition-all bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">Sign up</button></div><form id="auth-form" class="space-y-4"><div id="name-field-container" class="hidden"><input class="w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 rounded-xl px-4 py-2.5 transition-shadow focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Your name" name="name" /></div><input class="w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 rounded-xl px-4 py-2.5 transition-shadow focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" type="email" placeholder="email@address.com" name="email" required /><input class="w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 rounded-xl px-4 py-2.5 transition-shadow focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" type="password" placeholder="password" name="password" required />${error ? `<div class="text-sm text-red-600 dark:text-red-400 text-center">${error}</div>` : ''}${notice ? `<div class="text-sm text-green-700 dark:text-green-400 text-center">${notice}</div>` : ''}<button type="submit" ${loading ? 'disabled' : ''} class="w-full bg-indigo-600 dark:bg-indigo-500 text-white font-semibold rounded-xl py-2.5 hover:bg-indigo-700 dark:hover:bg-indigo-600 active:scale-[0.98] transition-all disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">${loading ? `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Please wait...` : 'Sign in'}</button></form><div class="text-[11px] text-gray-500 dark:text-gray-400 text-center">By continuing you agree this is supportive self-care and not a substitute for professional diagnosis or treatment.</div></div></div>`;
        }

        function renderAppShell() {
             appRoot.innerHTML = `<div class="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-rose-50 dark:from-gray-900 dark:via-gray-950 dark:to-black text-gray-800 dark:text-gray-200"><header class="sticky top-0 backdrop-blur-lg bg-white/70 dark:bg-gray-950/70 border-b border-gray-200/80 dark:border-gray-800/80 z-20"><div class="max-w-6xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between"><div class="flex items-center gap-3"><svg class="w-8 h-8 text-indigo-500" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16.5 16.5H14.5L12 13.25L9.5 16.5H7.5L11 12.25V7.5H13V12.25L16.5 16.5Z"/></svg><h1 class="font-bold text-xl text-gray-800 dark:text-gray-100">YouthMind<br><h4>Vers_1.2</h4></h1></div><div class="flex items-center gap-2 sm:gap-4 text-sm"><!--<button id="theme-toggle-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors"><svg id="theme-icon-sun" class="w-5 h-5 text-gray-700 ${isDarkMode ? 'hidden' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><svg id="theme-icon-moon" class="w-5 h-5 text-gray-300 ${!isDarkMode ? 'hidden' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button>--><div class="relative"><button id="profile-btn" class="flex items-center gap-2 px-3 py-2 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold hover:from-indigo-600 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105"><div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg></div><span class="hidden sm:block">Hi, ${profile?.displayName || "Friend"}</span><svg class="w-4 h-4 transition-transform duration-200" id="profile-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="profile-dropdown" class="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-xl shadow-xl border dark:border-gray-700 opacity-0 invisible transform scale-95 transition-all duration-200 z-50"><div class="p-4 border-b dark:border-gray-700"><div class="flex items-center gap-3"><div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center"><svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg></div><div><h3 class="font-semibold text-gray-900 dark:text-white">${profile?.displayName || "Friend"}</h3><p class="text-sm text-gray-500 dark:text-gray-400">${profile?.email || user?.email || "user@example.com"}</p></div></div></div><div class="py-2"><button id="profile-view-btn" class="w-full px-4 py-3 text-left text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-3"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>Profile</button><button id="quiz-btn" class="w-full px-4 py-3 text-left text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-3"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Mental Health Quiz</button><button id="events-btn" class="w-full px-4 py-3 text-left text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-3"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>Events</button><button id="movie-player-btn" class="w-full px-4 py-3 text-left text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-3"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>Motivational Movies</button><button id="breathing-exercise-btn" class="w-full px-4 py-3 text-left text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-3">
    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    Deep Breathing & Relaxation
</button><!-- Add this button with the others in the profile dropdown -->
<button id="about-us-btn" class="w-full px-4 py-3 text-left text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-3">
    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    About Us
</button><button id="delete-all-chats-btn" class="w-full px-4 py-3 text-left text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center gap-3">
    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
    </svg>
    Delete All Messages
</button><button id="sign-out-btn" class="w-full px-4 py-3 text-left text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center gap-3"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>Sign out</button></div></div></div></div></div></header><main id="main-content" class="max-w-6xl mx-auto px-4 sm:px-6 py-6 sm:py-8 fade-in"></main>
                    <footer class="max-w-6xl mx-auto px-4 sm:px-6 pb-8 text-xs text-gray-500 dark:text-gray-400 text-center space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-left text-gray-600 dark:text-gray-400">
                            <div class="col-span-2 md:col-span-1">
                                <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200">YouthMind</h4>
                                <p class="mt-1">Your daily companion for mental wellness.</p>
                            </div>
                            <div><h5 class="font-semibold">Benefits</h5><ul class="mt-1 space-y-1"><li>Your Personal Buddy</li><li>A Safe Space to Share</li><li>Track Your Journey</li><li>Mindful Activities</li><li>Avoid Self-Harm Convo</li></ul></div>
                            <div><h5 class="font-semibold">Support</h5><ul class="mt-1 space-y-1"><li>Not a medical device</li><li>For emergencies in India dial 112</li></ul></div>
                             <div class="col-span-2 md:col-span-2 text-right">
                                <p class="font-semibold">Created by MuditWebDev</p>
                                <p class="font-bold text-indigo-500">Made with love, for love.</p>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-800 pt-4 text-center">
                            <p>&copy; ${new Date().getFullYear()} YouthMind. All Rights Reserved.</p>
                        </div>
                    </footer>
                </div>`;
        }
       function renderAboutUsModal() {
    featureContainer.innerHTML = `
        <div id="about-us-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 pointer-events-auto z-50">
            <div class="modal-content w-full max-w-4xl bg-gradient-to-br from-white to-gray-50 dark:from-gray-900 dark:to-gray-800 rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden border border-gray-200 dark:border-gray-700 transform transition-all duration-300 scale-95 opacity-0">
                <!-- Header -->
                <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl">
                            <svg class="w-7 h-7 text-white" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM16.5 16.5H14.5L12 13.25L9.5 16.5H7.5L11 12.25V7.5H13V12.25L16.5 16.5Z"/>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">About YouthMind</h2>
                    </div>
                    <button id="close-about-modal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-gray-500 dark:text-gray-400">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                    <div class="space-y-8">
                        <!-- Hero Section -->
                        <div class="text-center py-4">
                            <div class="inline-flex items-center justify-center p-4 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl mb-4">
                                <span class="text-4xl">üíö</span>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">Mental Wellness Reimagined</h3>
                            <p class="text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
                                YouthMind is an AI-powered mental health companion designed specifically for young adults in India, 
                                providing a safe, confidential space to express feelings and access mental well-being resources.
                            </p>
                        </div>
                        
                        <!-- Inspiration -->
                        <div class="bg-gradient-to-r from-cyan-50 to-blue-50 dark:from-cyan-900/20 dark:to-blue-900/20 p-5 rounded-2xl border border-cyan-100 dark:border-cyan-800/50 transition-all duration-300 hover:shadow-lg">
                            <h3 class="text-lg font-semibold text-cyan-800 dark:text-cyan-200 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Inspiration & Vision
                            </h3>
                            <p class="text-gray-700 dark:text-gray-300">
                                Created for Google's GenAI Hackathon, YouthMind addresses the growing mental health challenges 
                                faced by young adults in India. We believe AI can provide accessible, immediate support to 
                                bridge the gap in mental health resources.
                            </p>
                        </div>
                        
                        <!-- Features Grid -->
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-5 flex items-center gap-2">
                                <svg class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Premium Features
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${[
                                    'AI-powered chat companion with emotional intelligence',
                                    'Daily mood tracking with visual analytics',
                                    'Interactive mood calendar & history',
                                    '30-day mood trend visualization',
                                    'Personalized music therapy based on mood',
                                    'Motivational video content library',
                                    'Guided deep breathing exercises',
                                    'Mental health assessment quizzes',
                                    'Direct counselor connections via WhatsApp',
                                    'Mental wellness events calendar',
                                    'Achievement badges & progress tracking',
                                    'Privacy-first design with data encryption'
                                ].map(feature => `
                                    <div class="feature-item flex items-start gap-3 p-3 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-md hover:border-indigo-300 dark:hover:border-indigo-500 hover:-translate-y-0.5">
                                        <span class="text-green-500 mt-0.5">‚úì</span>
                                        <span class="text-gray-700 dark:text-gray-300">${feature}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Creator Section -->
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 p-5 rounded-2xl border border-purple-100 dark:border-purple-800/50">
                            <h3 class="text-lg font-semibold text-purple-800 dark:text-purple-200 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                Created With ‚ù§Ô∏è by MuditWebDev
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Creator Info -->
                                <div class="flex items-center gap-4 p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                                    <div class="flex-shrink-0 w-14 h-14 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg">MWD</div>
                                    <div>
                                        <h4 class="font-semibold text-gray-900 dark:text-white">MuditWebDev</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Full Stack Developer & UI/UX Designer</p>
                                    </div>
                                </div>
                                
                                <!-- Links -->
                                <div class="space-y-3">
                                    <a href="https://www.linkedin.com/in/muditwebdev" target="_blank" class="social-link group flex items-center gap-3 p-3 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-md hover:border-blue-500 dark:hover:border-blue-500">
                                        <div class="flex-shrink-0 w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center group-hover:bg-blue-500 transition-colors">
                                            <svg class="w-5 h-5 text-blue-500 group-hover:text-white transition-colors" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                                            </svg>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">LinkedIn Profile</span>
                                    </a>
                                    
                                    <a href="mailto:contact@muditwebdev.com" class="social-link group flex items-center gap-3 p-3 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-md hover:border-red-500 dark:hover:border-red-500">
                                        <div class="flex-shrink-0 w-10 h-10 bg-red-100 dark:bg-red-900/30 rounded-lg flex items-center justify-center group-hover:bg-red-500 transition-colors">
                                            <svg class="w-5 h-5 text-red-500 group-hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                            </svg>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300 group-hover:text-red-600 dark:group-hover:text-red-400 transition-colors">contact@muditwebdev.com</span>
                                    </a>
                                    
                                    <a href="https://github.com/MuditWebDev" target="_blank" class="social-link group flex items-center gap-3 p-3 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-md hover:border-gray-800 dark:hover:border-gray-400">
                                        <div class="flex-shrink-0 w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center group-hover:bg-gray-800 transition-colors">
                                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-200 group-hover:text-white dark:group-hover:text-white transition-colors" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                            </svg>
                                        </div>
                                        <span class="text-gray-700 dark:text-gray-300 group-hover:text-gray-800 dark:group-hover:text-gray-200 transition-colors">GitHub Portfolio</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Call to Action -->
                        <div class="text-center pt-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Experience more innovative projects</p>
                            <a href="https://muditwebdev.com" target="_blank" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold rounded-xl hover:from-indigo-600 hover:to-purple-700 transition-all duration-300 transform hover:-translate-y-0.5 hover:shadow-lg">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                                </svg>
                                Visit My Portfolio
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Animate modal entrance
    setTimeout(() => {
        const modal = document.querySelector('.modal-content');
        if (modal) {
            modal.classList.remove('scale-95', 'opacity-0');
            modal.classList.add('scale-100', 'opacity-100');
        }
    }, 10);
}
        function renderAppContent(loading = false) {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            mainContent.innerHTML = `
                <div class="mb-6 p-4 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg text-center text-indigo-800 dark:text-indigo-200 slide-up">
                    <p class="text-lg font-medium">${GREETINGS(profile?.displayName || "Friend")}</p>
                </div>
                
                <!-- First Row: Mood + Calendar + Chat -->
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 sm:gap-8 mb-4">
                    <!-- Left Side - Mood & Calendar (Stacked) -->
                    <div class="lg:col-span-5 space-y-6">
                        ${loading ? renderMoodPickerSkeleton() : renderMoodPicker()}
                        ${loading ? renderCalendarSkeleton() : renderCalendar(calendarMap)}
                    </div>
                    
                    <!-- Right Side - Chat Area (Full Height) -->
                    <div class="lg:col-span-7">
                        ${loading ? renderChatSkeleton() : renderChatBox()}
                    </div>
                    </div>
                    
                <!-- Second Row: Music Player + 30 Days Graph -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 mb-4">
                    <!-- Music Player -->
                    <div class="w-full">
                        ${loading ? renderMusicPlayerSkeleton() : renderMusicPlayer()}
                    </div>
                    
                    <!-- 30 Days Graph -->
                    <div class="w-full">
                        ${loading ? renderChartSkeleton() : renderMoodChart(chartData)}
                    </div>
                </div>
                
                <!-- Counselor Section -->
                <div class="mt-8">
                    ${renderCounselorSection()}
                </div>
                `;
             if (!loading) {
                updateChatMessages(chatMessages, false, false);
                renderNotes();
             }
        }
        
        function renderMoodPicker() {
             return `
                <div id="mood-picker" class="bg-white/80 dark:bg-gray-900/70 backdrop-blur-lg rounded-3xl shadow-xl p-6 sm:p-8 slide-up w-full overflow-hidden dark:border dark:border-gray-800">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200">How are you feeling today?</h3>
                        <span class="text-sm text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-3 py-2 rounded-lg">${dateId()}</span>
                    </div>
                    <div class="grid grid-cols-5 gap-3 sm:gap-4 mb-6">
                        ${MOODS.map(m => `
                            <button data-score="${m.score}" aria-label="Select mood: ${m.label}" class="mood-btn flex flex-col items-center justify-center rounded-2xl border-2 border-gray-200 dark:border-gray-700 py-4 sm:py-5 transition-all duration-300 transform hover:scale-110 hover:shadow-lg dark:hover:bg-gray-800 ${todayMood?.score === m.score ? 'bg-indigo-600 text-white border-indigo-600 dark:border-indigo-500 shadow-lg scale-105' : 'hover:bg-gray-50'}">
                                <div class="text-3xl sm:text-4xl mb-2">${m.emoji}</div>
                                <div class="text-xs sm:text-sm font-semibold text-center">${m.label}</div>
                            </button>`).join('')}
                    </div>
                    <div class="space-y-4">
                        <div id="notes-list" class="space-y-3"></div>
                        <div class="flex flex-col sm:flex-row gap-3">
                           <input id="note-input" class="flex-1 bg-gray-50 dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 rounded-2xl p-3 text-sm focus:ring-4 focus:ring-indigo-200 focus:ring-opacity-50 dark:text-white" placeholder="Add a note for today..."/>
                           <button id="add-note-btn" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 active:scale-95 transition-all shadow-lg hover:shadow-xl">Add Note</button>
                        </div>
                    </div>
                </div>`;
        }
        
        function renderBreathingModal() {
    featureContainer.innerHTML = `
        <div id="breathing-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 pointer-events-auto z-50">
            <div class="modal-content w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden">
                <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Deep Breathing Exercise</h2>
                    <button id="close-breathing-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-2xl leading-none">&times;</button>
                </div>
                <div class="p-6 text-center">
                    <div id="breathing-container" class="relative w-64 h-64 mx-auto mb-6">
                        <div id="breathing-circle" class="absolute inset-0 bg-indigo-500 rounded-full opacity-20 transform scale-50 transition-all duration-700 ease-in-out"></div>
                        <div id="breathing-text" class="absolute inset-0 flex items-center justify-center text-2xl font-bold text-gray-800 dark:text-gray-200">Ready?</div>
                    </div>
                    <p id="breathing-instruction" class="text-gray-600 dark:text-gray-400 mb-6">Take a moment to relax and focus on your breathing</p>
                    <button id="start-breathing-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors">Start Breathing</button>
                    <button id="more-breathing-btn" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors hidden mt-3">More Breaths?</button>
                </div>
            </div>
        </div>
    `;
    
    // Add event listeners for the breathing modal
    document.getElementById('close-breathing-modal').addEventListener('click', closeBreathingModal);
    document.getElementById('start-breathing-btn').addEventListener('click', startBreathingExercise);
    document.getElementById('more-breathing-btn').addEventListener('click', startBreathingExercise);
}
        function renderNotes() {
            const notesListEl = document.getElementById('notes-list');
            if (!notesListEl) return;
            const notes = todayMood?.notes || [];
            notesListEl.innerHTML = notes.map((note, index) => `
                <div class="note-item flex items-center gap-3 bg-gray-100 dark:bg-gray-800 p-2.5 rounded-lg fade-in">
                    <p class="text-sm flex-grow">${note}</p>
                     <button data-note-index="${index}" class="note-delete-btn flex-shrink-0 w-6 h-6 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-500 dark:hover:bg-red-900/50 grid place-items-center transition-colors">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        function renderCalendar(items) {
            const now = new Date();
            const year = now.getFullYear(), month = now.getMonth();
            const startDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const cells = Array(startDay).fill(null).concat(Array.from({ length: daysInMonth }, (_, i) => i + 1));
            const scoreToEmoji = (score) => MOODS.find(m => m.score === score)?.emoji || '¬∑';

            return `
                <div class="bg-white/80 dark:bg-gray-900/70 backdrop-blur-lg rounded-3xl shadow-xl p-6 sm:p-8 slide-up w-full overflow-hidden dark:border dark:border-gray-800" style="animation-delay: 100ms;">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200">This Month</h3>
                        <span class="text-sm text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-3 py-2 rounded-lg">${now.toLocaleString('default', { month: 'long', year: 'numeric' })}</span>
                    </div>
                    <div class="grid grid-cols-7 gap-2 text-center text-sm text-gray-500 dark:text-gray-400 font-bold mb-4">
                        ${['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => `<div class="py-2">${d}</div>`).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-2">
                        ${cells.map(d => {
                            const id = d ? dateId(new Date(year, month, d)) : null;
                            const score = id ? items[id] : undefined;
                            return `
                                <div class="h-14 rounded-xl flex items-center justify-center ${d ? 'border-2 border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all duration-200 hover:scale-105 cursor-pointer' : ''}">
                                    ${d ? `<div class="flex flex-col items-center leading-tight"><span class="text-xs text-gray-400 dark:text-gray-500 mb-1 font-medium">${d}</span><span class="text-xl">${scoreToEmoji(score)}</span></div>` : ''}
                                </div>`;
                        }).join('')}
                    </div>
                </div>`;
        }
        
        function renderChatBox() {
            return `
                 <div id="chat-box" class="bg-white/80 dark:bg-gray-900/70 backdrop-blur-lg rounded-3xl shadow-xl flex flex-col slide-up w-full overflow-hidden dark:border dark:border-gray-800" style="animation-delay: 150ms; min-height: 700px; max-height: 90vh; resize: both; overflow: hidden;">
                    <div id="chat-alert-box"></div>
                    <div id="chat-messages" class="flex-1 overflow-auto p-6 space-y-4 flex items-center justify-center">
                        <div id="chat-welcome-message" class="text-center py-16 px-8 max-w-lg">
                            <div class="text-9xl mb-8">üí¨</div>
                            <h3 class="text-3xl font-bold text-gray-700 dark:text-gray-300 mb-6">Let's initiate a message, everything will be fine.</h3>
                            <p class="text-xl text-gray-600 dark:text-gray-400 mb-8">Start a conversation about anything on your mind - I'm here to listen and support you.</p>
                            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/30 dark:to-purple-900/30 rounded-2xl p-6 border-2 border-indigo-200 dark:border-indigo-800">
                                <p class="text-base leading-relaxed text-gray-700 dark:text-gray-300">Start a conversation about anything on your mind - I'm here to listen and support you.</p>
                        </div>
                    </div>
                    </div>
                    <div class="p-6 border-t-2 border-gray-200 dark:border-gray-800 flex gap-4 items-center flex-shrink-0">
                        <input id="chat-input" class="flex-1 bg-gray-100 dark:bg-gray-800 border-2 border-transparent rounded-2xl px-6 py-4 text-base focus:ring-4 focus:ring-indigo-500 focus:border-indigo-500 dark:text-white transition-all" placeholder="Say anything..." />
                        <button id="chat-send-btn" aria-label="Send message" class="p-4 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 active:scale-95 transition-all shadow-lg hover:shadow-xl">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                        </button>
                    </div>
                </div>`;
        }
        
        function renderMusicPlayer() {
            const currentMoodData = MOODS.find(m => m.label === currentMusicCategory);
            const trackCount = MUSIC_CATEGORIES[currentMusicCategory]?.length || 0;
            const assignment = MUSIC_TRACK_ASSIGNMENTS[currentMusicCategory];
            
            return `
                <div id="music-player" class="bg-white/80 dark:bg-gray-900/70 backdrop-blur-lg rounded-2xl shadow-lg p-4 slide-up dark:border dark:border-gray-800" style="animation-delay: 200ms;">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-12c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z"></path></svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-sm">Keep Shining ‚ú®</h4>
                                <p id="track-name" class="text-xs text-gray-500 dark:text-gray-400 music-player-track">Soothing Sounds</p>
                                <div class="flex items-center gap-2 text-xs text-gray-400 dark:text-gray-500">
                                    <span class="text-lg">${currentMoodData?.emoji}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 sm:gap-2">
                           <button id="shuffle-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors ${isShuffled ? 'text-indigo-500' : 'text-gray-500'}">
                               <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 3zM3.055 6.333A.75.75 0 014 7.252v5.496l1.22-.813a.75.75 0 01.96 1.154l-2.25 1.5a.75.75 0 01-.96-.002l-2.25-1.5a.75.75 0 11.96-1.152l1.22.813V7.252a.75.75 0 01.945-.919zM10 15a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 15zm-4.945-8.667a.75.75 0 01.945.919V12.75l-1.22.813a.75.75 0 11-.96-1.152l2.25-1.5a.75.75 0 01.96-.002l2.25 1.5a.75.75 0 11-.96 1.154l-1.22-.813v-5.496a.75.75 0 01-.75-.919zM16.945 6.333a.75.75 0 01.75.919v5.496l1.22-.813a.75.75 0 11.96 1.154l-2.25 1.5a.75.75 0 01-.96-.002l-2.25-1.5a.75.75 0 11.96-1.152l1.22.813V7.252a.75.75 0 01.75-.919z" clip-rule="evenodd"></path></svg>
                           </button>
                           <button id="play-pause-btn" class="p-2.5 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 active:scale-95 transition-all shadow-md">
                               <svg id="play-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                               <svg id="pause-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 4.5a.75.75 0 00-.75.75v10a.75.75 0 001.5 0V5.25A.75.75 0 005.75 4.5zm8.5 0a.75.75 0 00-.75.75v10a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75z"></path></svg>
                           </button>
                           <button id="next-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors text-gray-500">
                               <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M15.95 10.354a.75.75 0 000-1.06l-4.5-4.5a.75.75 0 10-1.06 1.06L14.06 9.25H4.75a.75.75 0 100 1.5h9.31l-3.67 3.67a.75.75 0 101.06 1.06l4.5-4.5z" clip-rule="evenodd"></path></svg>
                           </button>
                        </div>
                    </div>
                </div>`;
        }
        
        function renderCounselorSection() {
            return `
                <div class="mt-8 text-center slide-up" style="animation-delay: 300ms;">
                     <h2 class="text-2xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-3xl">Ready to talk to someone?</h2>
                     <p class="mt-4 max-w-2xl mx-auto text-lg leading-8 text-gray-600 dark:text-gray-400">
                        It's okay to not be okay. Talking about your mental health is a sign of strength, not weakness. Our professional counselors are here to provide a safe, confidential space for you to explore your feelings.
                     </p>
                </div>
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6 sm:gap-8 slide-up" style="animation-delay: 400ms;">
                    ${COUNSELORS.map(c => `
                        <div class="bg-white/80 dark:bg-gray-900/70 backdrop-blur-lg rounded-2xl shadow-lg p-6 text-center dark:border dark:border-gray-800">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${c.name}</h3>
                            <p class="text-sm text-indigo-500 dark:text-indigo-400 mt-1">${c.degree}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">${c.experience} of experience</p>
                             <a href="https://wa.me/${c.whatsapp}?text=${encodeURIComponent("Hello, I'd like to connect from YouthMind.")}" target="_blank" class="mt-4 inline-block w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                                Connect on WhatsApp (Free)
                            </a>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ===== PROFILE MODAL FUNCTIONS =====
        function renderProfileModal() {
            const userBadges = getUserBadges();
            const joinDate = profile?.joinedAt ? new Date(profile.joinedAt.seconds * 1000).toLocaleDateString() : 'Recently';
            const totalMoods = Object.keys(calendarMap).length;
            const streakDays = calculateStreakDays();
            
            featureContainer.innerHTML = `
                <div id="profile-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 pointer-events-auto z-50">
                    <div class="modal-content w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-h-[90vh] overflow-hidden">
                        <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Profile</h2>
                            <button id="close-profile-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-3xl leading-none cursor-pointer">&times;</button>
                        </div>
                        <div class="overflow-y-auto max-h-[calc(90vh-120px)]">
                            <div class="p-6 space-y-6">
                                <!-- Profile Header -->
                                <div class="text-center">
                                    <div class="w-24 h-24 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">${profile?.displayName || "Friend"}</h3>
                                    <p class="text-gray-500 dark:text-gray-400">${profile?.email || user?.email || "user@example.com"}</p>
                                    <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">Member since ${joinDate}</p>
                                </div>

                                <!-- Stats -->
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
                                        <div class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">${totalMoods}</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">Moods Tracked</div>
                                    </div>
                                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
                                        <div class="text-2xl font-bold text-green-600 dark:text-green-400">${streakDays}</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">Day Streak</div>
                                    </div>
                                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
                                        <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">${userBadges.length}</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">Badges Earned</div>
                                    </div>
                                </div>

                                <!-- Badges Section -->
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Achievement Badges</h4>
                                    <div class="badge-grid">
                                        ${userBadges.map(badge => `
                                            <div class="flex flex-col items-center p-4 bg-gradient-to-br ${badge.gradient} rounded-xl text-white text-center">
                                                <div class="text-3xl mb-2">${badge.emoji}</div>
                                                <div class="font-semibold text-sm">${badge.name}</div>
                                                <div class="text-xs opacity-90 mt-1">${badge.description}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEditProfileModal() {
            featureContainer.innerHTML = `
                <div id="edit-profile-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 pointer-events-auto z-50">
                    <div class="modal-content w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-xl">
                        <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Edit Username</h2>
                            <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-2xl leading-none">&times;</button>
                        </div>
                        <form id="edit-profile-form" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Username</label>
                                <input type="text" id="edit-display-name" value="${profile?.displayName || ''}" placeholder="Enter your username" class="w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-xl px-4 py-3 text-gray-900 dark:text-white focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">This will be displayed in the header and profile</p>
                            </div>
                            <div class="flex gap-3 pt-4">
                                <button type="button" id="cancel-edit-btn" class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">Cancel</button>
                                <button type="submit" class="flex-1 px-4 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        // ===== MOVIE PLAYER FUNCTIONS =====
        function renderMoviePlayerModal() {
            const randomVideoId = MOTIVATIONAL_VIDEOS[Math.floor(Math.random() * MOTIVATIONAL_VIDEOS.length)];
            
            featureContainer.innerHTML = `
                <div id="movie-player-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 pointer-events-auto z-50">
                    <div class="modal-content w-full max-w-6xl bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-h-[95vh] overflow-hidden">
                        <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Motivational Movie Scenes</h2>
                            <button id="close-movie-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-3xl leading-none cursor-pointer">&times;</button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[calc(95vh-120px)] scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-gray-100 dark:scrollbar-track-gray-800">
                            <!-- Custom Movie Player -->
                            <div class="relative bg-black rounded-xl overflow-hidden shadow-2xl mb-6" style="padding-bottom: 56.25%; height: 0;">
                             <iframe id="movie-iframe"
    src="https://www.youtube.com/embed/${randomVideoId}?rel=0&modestbranding=1&autohide=1&showinfo=0&enablejsapi=1"
    class="absolute top-0 left-0 w-full h-full border-0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    referrerpolicy="no-referrer-when-downgrade"
    allowfullscreen>
</iframe>
                                <!-- Custom Overlay Controls -->
                                <div class="absolute inset-0 pointer-events-none">
                                    <div class="absolute top-4 left-4 bg-black/50 backdrop-blur-sm rounded-lg px-3 py-2 text-white text-sm font-medium">
                                        üé¨ Motivational Scene
                                    </div>
                                    <div class="absolute bottom-4 right-4 bg-black/50 backdrop-blur-sm rounded-lg px-3 py-2 text-white text-sm">
                                        <button id="next-video-btn" class="pointer-events-auto hover:text-indigo-400 transition-colors">
                                            Next Scene ‚Üí
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Video Info and Controls -->
                            <div class="space-y-4">
                                <div class="text-center">
                                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Inspirational Movie Moments</h3>
                                    <p class="text-gray-600 dark:text-gray-400">Get motivated with powerful scenes from Bollywood and Hollywood movies</p>
                                </div>
                                
                                <!-- Quick Access Buttons -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <button class="video-category-btn px-4 py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white font-semibold rounded-xl hover:from-red-600 hover:to-pink-700 transition-all transform hover:scale-105" data-category="bollywood">
                                        üé≠ Bollywood
                                    </button>
                                    <button class="video-category-btn px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all transform hover:scale-105" data-category="hollywood">
                                        üé¨ Hollywood
                                    </button>
                                    <button class="video-category-btn px-4 py-3 bg-gradient-to-r from-green-500 to-teal-600 text-white font-semibold rounded-xl hover:from-green-600 hover:to-teal-700 transition-all transform hover:scale-105" data-category="sports">
                                        ‚öΩ Sports
                                    </button>
                                    <button class="video-category-btn px-4 py-3 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-semibold rounded-xl hover:from-purple-600 hover:to-violet-700 transition-all transform hover:scale-105" data-category="random">
                                        üé≤ Random
                                    </button>
                                </div>
                                
                                <!-- Playlist -->
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Suggested Videos</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-80 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-gray-100 dark:scrollbar-track-gray-800 pr-2">
                                        ${MOTIVATIONAL_VIDEOS.slice(0, 8).map((videoId, index) => `
                                            <button class="video-thumbnail-btn p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors text-left" data-video-id="${videoId}">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-16 h-12 bg-gray-300 dark:bg-gray-600 rounded flex items-center justify-center flex-shrink-0">
                                                        <svg class="w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M8 5v10l8-5-8-5z"></path>
                                                        </svg>
                                                    </div>
                                                    <div class="flex-1 min-w-0">
                                                        <div class="font-medium text-gray-900 dark:text-white text-sm">Motivational Video</div>
                                                        <div class="text-xs text-gray-500 dark:text-gray-400">Click to play</div>
                                                    </div>
                                                </div>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== EVENTS MODAL FUNCTION =====
        function renderEventsModal() {
            featureContainer.innerHTML = `
                <div id="events-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 pointer-events-auto z-50">
                    <div class="modal-content w-full max-w-4xl bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-h-[90vh] overflow-hidden">
                        <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Upcoming Events</h2>
                            <button id="close-events-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-3xl leading-none cursor-pointer">&times;</button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${EVENTS_DATA.map(event => `
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6 hover:shadow-lg transition-shadow">
                                        <div class="flex items-start justify-between mb-4">
                                            <div class="flex-1">
                                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">${event.title}</h3>
                                                <div class="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400 mb-3">
                                                    <div class="flex items-center gap-1">
                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                        </svg>
                                                        ${event.date}
                                                    </div>
                                                    <div class="flex items-center gap-1">
                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                        ${event.time}
                                                    </div>
                                                </div>
                                            </div>
                                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${getEventTypeColor(event.type)}">${event.type}</span>
                                        </div>
                                        <p class="text-gray-700 dark:text-gray-300 mb-4">${event.description}</p>
                                        <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                            ${event.location}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getEventTypeColor(type) {
            const colors = {
                wellness: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                education: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                workshop: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
                support: 'bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200'
            };
            return colors[type] || 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
        }

        // ===== HELPER FUNCTIONS =====
        function getUserBadges() {
            const badges = [];
            const totalMoods = Object.keys(calendarMap).length;
            const streakDays = calculateStreakDays();
            const totalChatMessages = chatMessages.length;
            
            // Mood tracking badges - Bronze to Diamond progression
            if (totalMoods >= 1) badges.push({
                name: "First Step",
                emoji: "üë∂",
                description: "Tracked your first mood",
                gradient: "from-amber-400 to-amber-600"
            });
            if (totalMoods >= 7) badges.push({
                name: "Week Warrior",
                emoji: "üóìÔ∏è",
                description: "Tracked moods for a week",
                gradient: "from-green-400 to-green-600"
            });
            
            if (totalMoods >= 30) badges.push({
                name: "Monthly Master",
                emoji: "üìÖ",
                description: "Tracked moods for a month",
                gradient: "from-blue-400 to-blue-600"
            });
            
            if (totalMoods >= 100) badges.push({
                name: "Century Champion",
                emoji: "üíØ",
                description: "Tracked 100+ moods",
                gradient: "from-purple-400 to-purple-600"
            });
            
            if (totalMoods >= 365) badges.push({
                name: "Year Legend",
                emoji: "üèÜ",
                description: "Tracked moods for a full year",
                gradient: "from-yellow-400 via-yellow-500 to-yellow-600"
            });
            
            // Streak badges - Fire progression with different colors
            if (streakDays >= 3) badges.push({
                name: "Streak Starter",
                emoji: "üî•",
                description: "3-day mood streak",
                gradient: "from-orange-400 to-orange-600"
            });
            
            if (streakDays >= 7) badges.push({
                name: "Streak Master I",
                emoji: "‚ö°",
                description: "7-day mood streak",
                gradient: "from-red-400 to-red-600"
            });
            
            if (streakDays >= 15) badges.push({
                name: "Streak Master II",
                emoji: "üî•",
                description: "15-day mood streak",
                gradient: "from-red-500 to-pink-600"
            });
            
            if (streakDays >= 30) badges.push({
                name: "Streak Master III",
                emoji: "‚ö°",
                description: "30-day mood streak",
                gradient: "from-purple-500 to-red-600"
            });
            
            if (streakDays >= 100) badges.push({
                name: "Streak Master IV",
                emoji: "üåü",
                description: "100-day mood streak",
                gradient: "from-yellow-400 via-red-500 to-purple-600"
            });
            
            // Chat badges - Conversation progression
            if (totalChatMessages >= 5) badges.push({
                name: "Chat Novice",
                emoji: "üí¨",
                description: "Had 5+ conversations",
                gradient: "from-cyan-400 to-cyan-600"
            });
            
            if (totalChatMessages >= 10) badges.push({
                name: "Chat Champion I",
                emoji: "üí¨",
                description: "Had 10+ conversations",
                gradient: "from-indigo-400 to-indigo-600"
            });
            
            if (totalChatMessages >= 30) badges.push({
                name: "Chat Champion II",
                emoji: "üí¨",
                description: "Had 30+ conversations",
                gradient: "from-indigo-500 to-purple-600"
            });
            
            if (totalChatMessages >= 50) badges.push({
                name: "Chat Champion III",
                emoji: "üí¨",
                description: "Had 50+ conversations",
                gradient: "from-purple-500 to-pink-600"
            });
            
            if (totalChatMessages >= 100) badges.push({
                name: "Chat Legend",
                emoji: "üó£Ô∏è",
                description: "Had 100+ conversations",
                gradient: "from-pink-500 via-purple-500 to-indigo-600"
            });
            
            // Mood variety badges
            const uniqueMoods = new Set(Object.values(calendarMap)).size;
            if (uniqueMoods >= 5) badges.push({
                name: "Mood Explorer",
                emoji: "üåà",
                description: "Experienced 5+ different moods",
                gradient: "from-pink-400 via-purple-500 to-indigo-600"
            });
            
            if (uniqueMoods >= 7) badges.push({
                name: "Mood Master",
                emoji: "üé≠",
                description: "Experienced all mood types",
                gradient: "from-purple-400 via-purple-500 to-pink-600"
            });
            
            // Consistency badges
            const positiveMoods = Object.values(calendarMap).filter(mood => 
                ['happy', 'excited', 'grateful', 'confident'].includes(mood)
            ).length;
            const positiveRatio = totalMoods > 0 ? positiveMoods / totalMoods : 0;
            
            if (positiveRatio >= 0.7 && totalMoods >= 10) badges.push({
                name: "Optimist",
                emoji: "‚òÄÔ∏è",
                description: "70%+ positive moods",
                gradient: "from-yellow-300 via-yellow-400 to-orange-500"
            });
            
            if (positiveRatio >= 0.8 && totalMoods >= 20) badges.push({
                name: "Sunshine Soul",
                emoji: "‚ú®",
                description: "80%+ positive moods",
                gradient: "from-yellow-200 via-yellow-300 to-yellow-500"
            });
            
            // Special achievement badges
            badges.push({
                name: "Mental Health Advocate",
                emoji: "üíö",
                description: "Taking care of yourself",
                gradient: "from-emerald-400 to-emerald-600"
            });
            
            if (totalMoods >= 7 && totalChatMessages >= 5) badges.push({
                name: "Wellness Warrior",
                emoji: "üõ°Ô∏è",
                description: "Active in both tracking and chatting",
                gradient: "from-teal-400 via-emerald-500 to-green-600"
            });
            
            if (streakDays >= 7 && totalChatMessages >= 10) badges.push({
                name: "Dedication Diamond",
                emoji: "üíé",
                description: "Consistent tracking and engagement",
                gradient: "from-cyan-300 via-blue-400 to-indigo-600"
            });
            
            return badges;
        }

        function calculateStreakDays() {
            let streak = 0;
            const today = new Date();
            
            for (let i = 0; i < 30; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateId = checkDate.toISOString().slice(0, 10);
                
                if (calendarMap[dateId] !== undefined) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        function renderMoodChart(data) {
           return `<div class="bg-white/80 dark:bg-gray-900/70 backdrop-blur-lg rounded-3xl shadow-xl p-5 sm:p-6 h-84 slide-up w-full overflow-hidden dark:border dark:border-gray-800" style="animation-delay: 250ms;"><h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4">Last 30 Days</h3><div class="w-full h-68 relative" id="chart-container-wrapper"></div></div>`;
        }

        function drawInteractiveChart(data) {
            const wrapper = document.getElementById('chart-container-wrapper');
            if (!wrapper || !data) return;
            wrapper.innerHTML = '';
            
            const tooltip = document.createElement('div');
            tooltip.className = 'absolute z-10 p-3 text-xs rounded-lg shadow-lg bg-white dark:bg-gray-800 border dark:border-gray-700 transition-all duration-200 opacity-0 pointer-events-none';
            wrapper.appendChild(tooltip);

            const canvas = document.createElement('canvas');
            wrapper.appendChild(canvas);
            const ctx = canvas.getContext('2d');
            
            const dpr = window.devicePixelRatio || 1;
            const rect = wrapper.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            canvas.style.width = `${rect.width}px`;
            canvas.style.height = `${rect.height}px`;

            const margin = { top: 12, right: 8, bottom: 25, left: 60 };
            const plotWidth = rect.width - margin.left - margin.right;
            const plotHeight = rect.height - margin.top - margin.bottom;

            const moodLabels = ["Very Sad", "Sad", "Neutral", "Happy", "Happy ++"];
            const scoreToY = (score) => plotHeight - ( (MOODS.findIndex(m=>m.score===score)) / (MOODS.length -1) * plotHeight );

            const validData = data.map((d,i) => d.score !== null ? { ...d, index: i } : null).filter(Boolean);
            const points = validData.map(d => ({
                x: (d.index / (data.length - 1 || 1)) * plotWidth + margin.left,
                y: scoreToY(d.score) + margin.top,
                data: d
            }));
            
            let animationFrameId;
            let currentHoverPoint = null;

            // Main draw function
            function draw(progress = 1) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw grid lines and labels
                moodLabels.forEach((label, index) => {
                    const y = plotHeight - (index / (moodLabels.length - 1)) * plotHeight + margin.top;
                    ctx.beginPath();
                    ctx.moveTo(margin.left, y);
                    ctx.lineTo(margin.left + plotWidth, y);
                    ctx.strokeStyle = isDarkMode ? 'rgba(55, 65, 81, 0.5)' : 'rgba(229, 231, 235, 0.7)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                    ctx.fillStyle = isDarkMode ? '#6b7280' : '#9ca3af';
                    ctx.font = '10px Inter';
                    ctx.textAlign = 'right';
                    ctx.fillText(label, margin.left - 12, y + 4);
                });

                // Draw path and gradient
                if(points.length > 1) {
                    ctx.save();
                    const endPoint = points[Math.floor((points.length - 1) * progress)];
                    ctx.beginPath();
                    ctx.rect(0, 0, endPoint.x + 5, rect.height);
                    ctx.clip();

                    ctx.beginPath();
                    ctx.moveTo(points[0].x, points[0].y);
                    for (let i = 0; i < points.length - 1; i++) {
                        const xc = (points[i].x + points[i+1].x) / 2;
                        const yc = (points[i].y + points[i+1].y) / 2;
                        ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
                    }
                    ctx.quadraticCurveTo(points[points.length-1].x, points[points.length-1].y, points[points.length-1].x, points[points.length-1].y);
                    
                    const lineStyle = isDarkMode ? "#a78bfa" : "#4f46e5";
                    ctx.strokeStyle = lineStyle;
                    ctx.lineWidth = 3;
                    ctx.shadowColor = isDarkMode ? 'rgba(167, 139, 250, 0.5)' : 'rgba(79, 70, 229, 0.5)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetY = 2;
                    ctx.stroke();
                    
                    // Reset shadow for gradient fill
                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetY = 0;

                    const gradient = ctx.createLinearGradient(0, 0, 0, rect.height);
                    gradient.addColorStop(0, isDarkMode ? 'rgba(139, 92, 246, 0.2)' : 'rgba(79, 70, 229, 0.3)');
                    gradient.addColorStop(1, isDarkMode ? 'rgba(139, 92, 246, 0)' : 'rgba(79, 70, 229, 0)');

                    ctx.lineTo(points[points.length-1].x, rect.height - margin.bottom);
                    ctx.lineTo(points[0].x, rect.height - margin.bottom);
                    ctx.closePath();
                    ctx.fillStyle = gradient;
                    ctx.fill();
                    ctx.restore();
                }
                
                // Draw points
                points.forEach((p, i) => {
                    if (p.x > points[Math.floor((points.length - 1) * progress)].x) return;
                    
                    const isHovered = currentHoverPoint === p;
                    const radius = isHovered ? 6 : 4;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
                    ctx.fillStyle = isDarkMode ? '#111827' : 'white';
                    ctx.fill();
                    ctx.strokeStyle = MOODS.find(m => m.score === p.data.score)?.color || '#4f46e5';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                });
            }

            let startTime = null;
            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const runtime = timestamp - startTime;
                const progress = Math.min(runtime / 800, 1);
                draw(progress);
                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(animate);
                }
            }
            
            animationFrameId = requestAnimationFrame(animate);
            
            // Mouse move for tooltips
            canvas.addEventListener('mousemove', (e) => {
                const mouseX = e.offsetX;
                const mouseY = e.offsetY;
                let foundPoint = null;
                for(const p of points) {
                    const dist = Math.sqrt(Math.pow(p.x - mouseX, 2) + Math.pow(p.y - mouseY, 2));
                    if(dist < 10) {
                        foundPoint = p;
                        break;
                    }
                }
                
                if (foundPoint && currentHoverPoint !== foundPoint) {
                    currentHoverPoint = foundPoint;
                    draw(1); // Redraw to show hover effect
                    const mood = MOODS.find(m => m.score === foundPoint.data.score);
                    let notesHTML = foundPoint.data.notes?.length > 0
                        ? `<ul class="mt-1 space-y-1">${foundPoint.data.notes.map(n => `<li class="list-disc ml-3.5">${n}</li>`).join('')}</ul>`
                        : '<p class="opacity-70 mt-1">No notes for this day.</p>';

                    tooltip.innerHTML = `<div class="font-bold text-gray-800 dark:text-gray-100 flex items-center gap-1.5"><span style="color:${mood.color}">${mood.emoji}</span>${mood.label} (${foundPoint.data.date.slice(5)})</div>${notesHTML}`;
                    tooltip.style.opacity = '1';
                    
                    const tooltipRect = tooltip.getBoundingClientRect();
                    let left = foundPoint.x + 15;
                    let top = foundPoint.y - 15;
                    if (left + tooltipRect.width > rect.width) {
                        left = foundPoint.x - tooltipRect.width - 15;
                    }

                    tooltip.style.transform = `translate(${left}px, ${top}px)`;
                    canvas.style.cursor = 'pointer';
                } else if (!foundPoint && currentHoverPoint) {
                    currentHoverPoint = null;
                    draw(1); // Redraw to remove hover effect
                    tooltip.style.opacity = '0';
                    canvas.style.cursor = 'default';
                }
            });
            
             canvas.addEventListener('mouseleave', () => {
                if (currentHoverPoint) {
                    currentHoverPoint = null;
                    draw(1);
                    tooltip.style.opacity = '0';
                    canvas.style.cursor = 'default';
                }
            });
        }


        // ===== 4.1) Skeleton Renderers =====
        function renderMoodPickerSkeleton() { return `<div class="bg-white/80 dark:bg-gray-900/70 rounded-2xl shadow-lg p-5 space-y-4"><div class="skeleton h-6 w-3/4"></div><div class="grid grid-cols-5 gap-3">${Array(5).fill(0).map(() => `<div class="skeleton h-24"></div>`).join('')}</div><div class="skeleton h-16 w-full"></div></div>`; }
        function renderCalendarSkeleton() { return `<div class="bg-white/80 dark:bg-gray-900/70 rounded-2xl shadow-lg p-5 space-y-3"><div class="skeleton h-6 w-1/2"></div><div class="grid grid-cols-7 gap-1">${Array(35).fill(0).map(() => `<div class="skeleton h-12"></div>`).join('')}</div></div>`; }
        function renderChatSkeleton() { return `<div class="bg-white/80 dark:bg-gray-900/70 rounded-2xl shadow-lg h-[26rem] flex flex-col justify-between p-3"><div class="space-y-3"><div class="skeleton h-10 w-3/5"></div><div class="skeleton h-12 w-4/5 ml-auto"></div><div class="skeleton h-8 w-1/2"></div></div><div class="skeleton h-12 w-full"></div></div>`; }
        function renderMusicPlayerSkeleton() { return `<div class="bg-white/80 dark:bg-gray-900/70 rounded-2xl shadow-lg p-4 h-[72px]"><div class="skeleton h-full w-full"></div></div>`; }
        function renderChartSkeleton() { return `<div class="bg-white/80 dark:bg-gray-900/70 rounded-2xl shadow-lg p-5 h-72 space-y-3"><div class="skeleton h-6 w-1/3"></div><div class="skeleton h-full w-full"></div></div>`; }

        function updateChatMessages(messages, isTyping, showAlert) {
            const chatMessagesEl = document.getElementById('chat-messages');
            const chatAlertBoxEl = document.getElementById('chat-alert-box');
            const welcomeMessageEl = document.getElementById('chat-welcome-message');
            if (!chatMessagesEl || !chatAlertBoxEl) return;

            chatAlertBoxEl.innerHTML = showAlert ? `<div class="bg-red-100 text-red-800 text-sm p-3 rounded-t-2xl font-medium fade-in dark:bg-red-900/30 dark:text-red-300">If you feel unsafe, call <b>112</b> (India). Consider speaking to a trusted person or a professional. You matter.</div>` : '';

            // Hide welcome message if there are messages
            if (welcomeMessageEl && messages.length > 0) {
                welcomeMessageEl.style.display = 'none';
                chatMessagesEl.classList.remove('flex', 'items-center', 'justify-center');
                chatMessagesEl.classList.add('space-y-3');
            } else if (welcomeMessageEl && messages.length === 0) {
                welcomeMessageEl.style.display = 'block';
                chatMessagesEl.classList.add('flex', 'items-center', 'justify-center');
                chatMessagesEl.classList.remove('space-y-3');
            }

            let messagesHtml = messages.map(m => `
                <div class="max-w-[85%] sm:max-w-[80%] w-fit text-sm slide-up ${m.sender==='user'?'ml-auto text-white bg-indigo-600 rounded-b-2xl rounded-tl-2xl shadow':'bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-b-2xl rounded-tr-2xl'}">
                    <div class="px-3.5 py-2.5 whitespace-pre-wrap">${m.text}</div>
                </div>`).join('');
            
            if (isTyping) {
                messagesHtml += `<div class="max-w-[80%] w-fit text-sm bg-gray-100 dark:bg-gray-800 rounded-b-2xl rounded-tr-2xl px-3.5 py-2.5 slide-up"><div class="flex items-center gap-2 typing-indicator"><span class="w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full"></span><span class="w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full"></span><span class="w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full"></span></div></div>`;
            }

            chatMessagesEl.innerHTML = messagesHtml;
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }
        
        // ===== 5) Music Logic =====
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getCurrentPlaylist() {
            return MUSIC_CATEGORIES[currentMusicCategory] || musicPlaylist;
        }

        function playNextSong() {
            currentTrackIndex++;
            const playlist = isShuffled ? shuffledPlaylist : getCurrentPlaylist();
            if (currentTrackIndex >= playlist.length) {
                currentTrackIndex = 0; // Loop playlist
                if (isShuffled) { // Re-shuffle when the playlist completes
                    shuffledPlaylist = shuffleArray([...getCurrentPlaylist()]);
                }
            }
            loadAndPlaySong();
        }

        function loadAndPlaySong() {
            const playlist = isShuffled ? shuffledPlaylist : getCurrentPlaylist();
            if (playlist.length === 0) return; // Don't play if playlist is empty
            const trackName = playlist[currentTrackIndex];
            audio.src = trackName;
            audio.play().catch(e => {
                // Autoplay can be blocked by browsers. This is a common issue.
                console.warn("Audio autoplay was blocked. User interaction is required to start playback.", e);
            });
            document.getElementById('play-icon').classList.add('hidden');
            document.getElementById('pause-icon').classList.remove('hidden');
        }

        function switchMusicCategory(category) {
            currentMusicCategory = category;
            currentTrackIndex = 0;
            shuffledPlaylist = shuffleArray([...getCurrentPlaylist()]);
            
            // Update the UI to reflect the new category
            const musicPlayer = document.getElementById('music-player');
            if (musicPlayer) {
                // Re-render the music player to update category display
                const musicPlayerContainer = musicPlayer.parentElement;
                const musicPlayerHTML = renderMusicPlayer();
                musicPlayerContainer.innerHTML = musicPlayerHTML;
                setupMusicEventListeners();
            }
        }

        function setupMusicEventListeners() {
            // This function can be used to set up any additional music-specific event listeners
            // Currently handled by the main setupEventListeners function
        }

        function updateMusicCategoryFromMood() {
            // Automatically switch music category based on today's mood
            if (todayMood && todayMood.score !== undefined) {
                const moodData = MOODS.find(m => m.score === todayMood.score);
                if (moodData && moodData.label !== currentMusicCategory) {
                    switchMusicCategory(moodData.label);
                }
            }
        }

        // ===== 6) Data Logic =====
        async function refreshMoodData(uid) {
            if (!uid) return;
            const moodPath = `artifacts/${appId}/moods/${uid}/days`;
            
            const id = dateId();
            const tDoc = await getDoc(doc(db, moodPath, id));
            todayMood = tDoc.exists() ? tDoc.data() : { notes: [] };

            const now = new Date();
            const year = now.getFullYear(), month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthPromises = Array.from({length: daysInMonth}, (_, i) => getDoc(doc(db, moodPath, dateId(new Date(year, month, i + 1)))));
            
            const seriesPromises = Array.from({length: 30}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (29-i));
                return getDoc(doc(db, moodPath, dateId(d)));
            });

            const [monthDocs, seriesDocs] = await Promise.all([Promise.all(monthPromises), Promise.all(seriesPromises)]);
            
            calendarMap = {};
            monthDocs.forEach(dd => { if (dd.exists()) calendarMap[dd.id] = dd.data().score; });

            chartData = seriesDocs.map((dd, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (29 - i));
                const data = dd.exists() ? dd.data() : {};
                return { date: dateId(d), score: data.score ?? null, notes: data.notes || [] };
            });
        }
        
        async function handleMoodPick(score) {
            const mood = MOODS.find(m => m.score === score);
            if (!user || !mood) return;

            const id = dateId();
            const moodPath = `artifacts/${appId}/moods/${user.uid}/days`;
            const userPath = `artifacts/${appId}/users/${user.uid}`;
            
            const moodData = { score: mood.score, label: mood.label, createdAt: serverTimestamp() };
            if (!todayMood) todayMood = { notes: [] };
            todayMood.score = mood.score;
            todayMood.label = mood.label;
            
            await setDoc(doc(db, moodPath, id), moodData, { merge: true });
            await setDoc(doc(db, userPath), { lastCheckIn: id }, { merge: true });
            
            await refreshMoodData(user.uid);
            renderAppContent(false);
            drawInteractiveChart(chartData);
            updateMusicCategoryFromMood();
        }

        async function handleAddNote() {
            const noteInput = document.getElementById('note-input');
            const noteText = noteInput.value.trim();
            if (!noteText || !user) return;
            
            noteInput.value = '';
            const id = dateId();
            const moodPath = `artifacts/${appId}/moods/${user.uid}/days`;
            const moodDocRef = doc(db, moodPath, id);
            
            await setDoc(moodDocRef, { notes: arrayUnion(noteText) }, { merge: true });
            if (!todayMood) todayMood = { notes: [] };
            if (!todayMood.notes) todayMood.notes = [];
            todayMood.notes.push(noteText);
            
            const todayInChart = chartData.find(d => d.date === id);
            if(todayInChart) todayInChart.notes.push(noteText);

            renderNotes();
        }

        async function handleDeleteNote(index) {
            const noteText = todayMood?.notes?.[index];
            if (!noteText || !user) return;
            
            const id = dateId();
            const moodPath = `artifacts/${appId}/moods/${user.uid}/days`;
            const moodDocRef = doc(db, moodPath, id);

            await updateDoc(moodDocRef, { notes: arrayRemove(noteText) });
            todayMood.notes.splice(index, 1);
            
            const todayInChart = chartData.find(d => d.date === id);
            if(todayInChart) todayInChart.notes = todayMood.notes;

            renderNotes();
        }

        async function handleChatSend() {
            const inputEl = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');
            const text = inputEl.value.trim();
            if (!text) return;

            inputEl.value = "";
            inputEl.disabled = true;
            sendBtn.disabled = true;

            const tempUserMessageId = `temp_${Date.now()}`;
            const userMessageData = { text, sender: "user", sentAt: new Date() }; // Use local date for immediate display
            chatMessages.push({ id: tempUserMessageId, ...userMessageData });
            updateChatMessages(chatMessages, true, document.getElementById('chat-alert-box').innerHTML !== '');
            
            try {
                const chatPath = `artifacts/${appId}/chats/${user.uid}/messages`;
                await addDoc(collection(db, chatPath), { text, sender: "user", sentAt: serverTimestamp() });
                
                const recentHistory = chatMessages.slice(-11, -1).map(m => ({
                    role: m.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: m.text }]
                }));

                const reply = await generateReply({ text, moodScore: todayMood?.score ?? 0, name: profile.displayName, chatHistory: recentHistory });
                await addDoc(collection(db, chatPath), { text: reply.text, sender: "bot", sentAt: serverTimestamp() });

            } catch (error) {
                console.error("Failed to send message:", error);
                chatMessages = chatMessages.filter(m => m.id !== tempUserMessageId);
                updateChatMessages(chatMessages, false, false);
            } finally {
                inputEl.disabled = false;
                sendBtn.disabled = false;
                inputEl.focus();
            }
        }
        function startBreathingExercise() {
    isBreathingExerciseActive = true;
    breathCycleCount = 0;
    
    document.getElementById('start-breathing-btn').classList.add('hidden');
    document.getElementById('more-breathing-btn').classList.add('hidden');
    
    runBreathingCycle();
}

function runBreathingCycle() {
    if (!isBreathingExerciseActive || breathCycleCount >= MAX_BREATH_CYCLES) {
        finishBreathingExercise();
        return;
    }
    
    const circle = document.getElementById('breathing-circle');
    const text = document.getElementById('breathing-text');
    const instruction = document.getElementById('breathing-instruction');
    
    // Inhale phase (4 seconds)
    text.textContent = "Breathe In";
    instruction.textContent = "Fill your lungs completely";
    circle.style.transform = 'scale(1)';
    circle.style.opacity = '0.7';
    circle.style.backgroundColor = '#4f46e5';
    
    setTimeout(() => {
        // Hold phase (2 seconds)
        text.textContent = "Hold";
        instruction.textContent = "Hold your breath for a moment";
        circle.style.opacity = '0.9';
        
        setTimeout(() => {
            // Exhale phase (6 seconds)
            text.textContent = "Breathe Out";
            instruction.textContent = "Release all the air slowly";
            circle.style.transform = 'scale(0.5)';
            circle.style.opacity = '0.2';
            circle.style.backgroundColor = '#8b5cf6';
            
            setTimeout(() => {
                breathCycleCount++;
                if (breathCycleCount < MAX_BREATH_CYCLES) {
                    runBreathingCycle();
                } else {
                    finishBreathingExercise();
                }
            }, 6000);
        }, 2000);
    }, 4000);
}

function finishBreathingExercise() {
    isBreathingExerciseActive = false;
    
    const text = document.getElementById('breathing-text');
    const instruction = document.getElementById('breathing-instruction');
    
    text.textContent = "Complete!";
    instruction.textContent = "You've completed 5 deep breaths. How do you feel?";
    
    document.getElementById('more-breathing-btn').classList.remove('hidden');
    
    // Reset circle
    const circle = document.getElementById('breathing-circle');
    circle.style.transform = 'scale(0.5)';
    circle.style.opacity = '0.2';
}

function closeBreathingModal() {
    isBreathingExerciseActive = false;
    const modal = document.getElementById('breathing-modal');
    if (modal) modal.remove();
}
        // ===== 7) Event Listeners & Main App Flow =====
        function applyTheme() {
            document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('youthmind-theme', isDarkMode ? 'dark' : 'light');
            
            // Update theme icons in header
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');
            if(sunIcon && moonIcon){
                sunIcon.classList.toggle('hidden', isDarkMode);
                moonIcon.classList.toggle('hidden', !isDarkMode);
            }
            
            if (user) drawInteractiveChart(chartData);
        }

        function setupEventListeners() {
            appRoot.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                // Add to your setupEventListeners function
if (target.id === 'delete-all-chats-btn') {
    document.getElementById('profile-dropdown').classList.remove('opacity-100', 'visible', 'scale-100');
    document.getElementById('profile-dropdown').classList.add('opacity-0', 'invisible', 'scale-95');
    document.getElementById('profile-arrow').style.transform = 'rotate(0deg)';
    
    // Show confirmation dialog
    if (confirm("This will permanently delete ALL your chat messages. This action cannot be undone. Continue?")) {
        deleteAllChats();
    }
}
if (target.id === 'about-us-btn') {
    document.getElementById('profile-dropdown').classList.remove('opacity-100', 'visible', 'scale-100');
    document.getElementById('profile-dropdown').classList.add('opacity-0', 'invisible', 'scale-95');
    document.getElementById('profile-arrow').style.transform = 'rotate(0deg)';
    renderAboutUsModal();
}// Close about us modal
// Add to your setupEventListeners function
if (target.id === 'cleanup-chats-btn') {
    document.getElementById('profile-dropdown').classList.remove('opacity-100', 'visible', 'scale-100');
    document.getElementById('profile-dropdown').classList.add('opacity-0', 'invisible', 'scale-95');
    document.getElementById('profile-arrow').style.transform = 'rotate(0deg)';
    
    // Show confirmation dialog
    if (confirm("This will permanently delete all chat messages older than 15 days. Continue?")) {
        autoDeleteOldChats();
    }
}

// Close about us modal
if (target.id === 'close-about-modal') {
    document.getElementById('about-us-modal').remove();
}
                if (target.id === 'mode-signin' || target.id === 'mode-signup') {
                    const isSignin = target.id === 'mode-signin';
                    document.getElementById('mode-signin').classList.toggle('bg-indigo-600', isSignin);
                    document.getElementById('mode-signin').classList.toggle('text-white', isSignin);
                    document.getElementById('mode-signin').classList.toggle('shadow-sm', isSignin);
                    document.getElementById('mode-signin').classList.toggle('bg-gray-100', !isSignin);
                    document.getElementById('mode-signin').classList.toggle('text-gray-700', !isSignin);
                    
                    document.getElementById('mode-signup').classList.toggle('bg-indigo-600', !isSignin);
                    document.getElementById('mode-signup').classList.toggle('text-white', !isSignin);
                    document.getElementById('mode-signup').classList.toggle('shadow-sm', !isSignin);
                    document.getElementById('mode-signup').classList.toggle('bg-gray-100', isSignin);
                    document.getElementById('mode-signup').classList.toggle('text-gray-700', isSignin);

                    document.getElementById('name-field-container').classList.toggle('hidden', isSignin);
                    document.querySelector('#auth-form button').innerHTML = isSignin ? 'Sign in' : 'Create account';
                }
                
                // Profile dropdown functionality
                if (target.id === 'profile-btn') {
                    const dropdown = document.getElementById('profile-dropdown');
                    const arrow = document.getElementById('profile-arrow');
                    const isOpen = dropdown.classList.contains('opacity-100');
                    
                    if (isOpen) {
                        dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
                        dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
                        arrow.style.transform = 'rotate(0deg)';
                    } else {
                        dropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
                        dropdown.classList.add('opacity-100', 'visible', 'scale-100');
                        arrow.style.transform = 'rotate(180deg)';
                    }
                }
                
                // Profile modal buttons
                if (target.id === 'profile-view-btn') {
                    document.getElementById('profile-dropdown').classList.remove('opacity-100', 'visible', 'scale-100');
                    document.getElementById('profile-dropdown').classList.add('opacity-0', 'invisible', 'scale-95');
                    document.getElementById('profile-arrow').style.transform = 'rotate(0deg)';
                    renderProfileModal();
                }
                
                if (target.id === 'movie-player-btn') {
                    document.getElementById('profile-dropdown').classList.remove('opacity-100', 'visible', 'scale-100');
                    document.getElementById('profile-dropdown').classList.add('opacity-0', 'invisible', 'scale-95');
                    document.getElementById('profile-arrow').style.transform = 'rotate(0deg)';
                    renderMoviePlayerModal();
                }
                if (target.id === 'breathing-exercise-btn') {
    document.getElementById('profile-dropdown').classList.remove('opacity-100', 'visible', 'scale-100');
    document.getElementById('profile-dropdown').classList.add('opacity-0', 'invisible', 'scale-95');
    document.getElementById('profile-arrow').style.transform = 'rotate(0deg)';
    renderBreathingModal();
}
                if (target.id === 'quiz-btn') {
                    document.getElementById('profile-dropdown').classList.remove('opacity-100', 'visible', 'scale-100');
                    document.getElementById('profile-dropdown').classList.add('opacity-0', 'invisible', 'scale-95');
                    document.getElementById('profile-arrow').style.transform = 'rotate(0deg)';
                    showQuizPopup();
                }
                
                if (target.id === 'events-btn') {
                    document.getElementById('profile-dropdown').classList.remove('opacity-100', 'visible', 'scale-100');
                    document.getElementById('profile-dropdown').classList.add('opacity-0', 'invisible', 'scale-95');
                    document.getElementById('profile-arrow').style.transform = 'rotate(0deg)';
                    renderEventsModal();
                }
                
                if (target.id === 'sign-out-btn') await signOut(auth);
                
                if (target.id === 'theme-toggle-btn') {
                    isDarkMode = !isDarkMode;
                    applyTheme();
                    // Force re-render to update all elements
                    if (user) {
                        renderAppContent(false);
                        drawInteractiveChart(chartData);
                    }
                }
                
                const moodBtn = target.closest('.mood-btn');
                if (moodBtn) handleMoodPick(parseInt(moodBtn.dataset.score, 10));
                if (target.id === 'chat-send-btn') handleChatSend();
                if (target.id === 'add-note-btn') {
                    e.preventDefault();
                    handleAddNote();
                }
                const deleteBtn = target.closest('.note-delete-btn');
                if (deleteBtn) {
                    const index = parseInt(deleteBtn.dataset.noteIndex, 10);
                    const noteItem = deleteBtn.parentElement;
                    noteItem.classList.add('deleting');
                    setTimeout(() => handleDeleteNote(index), 300);
                }
                
                // Music Player controls
                if (target.id === 'play-pause-btn') {
                    if (audio.paused) {
                        if (audio.src) { audio.play().catch(e=>console.error(e)); } else { loadAndPlaySong(); }
                    } else { audio.pause(); }
                }
                if (target.id === 'next-btn') playNextSong();
                if (target.id === 'shuffle-btn') {
                    isShuffled = !isShuffled;
                    target.classList.toggle('text-indigo-500', isShuffled);
                    target.classList.toggle('text-gray-500', !isShuffled);
                    if (isShuffled) {
                        shuffledPlaylist = shuffleArray([...getCurrentPlaylist()]);
                        currentTrackIndex = 0;
                    }
                }
                
            });

             appRoot.addEventListener('submit', async (e) => {
                if (e.target.id === 'auth-form') {
                    e.preventDefault();
                     const formData = new FormData(e.target);
                    const { email, password, name } = Object.fromEntries(formData.entries());
                    const isSignup = !document.getElementById('name-field-container').classList.contains('hidden');
                    renderAuthCard("", "", true);
                    try {
                        if (isSignup) {
                            const cred = await createUserWithEmailAndPassword(auth, email, password);
                            const displayName = titleCase(name || email.split("@")[0]);
                            await updateProfile(cred.user, { displayName });
                            await setDoc(doc(db, `artifacts/${appId}/users/${cred.user.uid}`), { displayName, joinedAt: serverTimestamp() });
                        } else {
                            await signInWithEmailAndPassword(auth, email, password);
                        }
                    } catch (err) {
                        const message = err.code ? err.code.replace('auth/', '').replace(/-/g, ' ') : err.message;
                        renderAuthCard(titleCase(message), "", false);
                    }
                }
                
                // Edit profile form submission
                if (e.target.id === 'edit-profile-form') {
                    e.preventDefault();
                    const displayName = document.getElementById('edit-display-name').value.trim();
                    
                    if (!displayName) {
                        alert('Username is required');
                        return;
                    }
                    
                    try {
                        const userPath = `artifacts/${appId}/users/${user.uid}`;
                        await updateDoc(doc(db, userPath), { 
                            displayName: titleCase(displayName),
                            updatedAt: serverTimestamp()
                        });
                        
                        // Update local profile
                        profile.displayName = titleCase(displayName);
                        
                        // Close edit modal and show profile modal
                        document.getElementById('edit-profile-modal').remove();
                        renderProfileModal();
                        
                        // Update header display name
                        const profileBtn = document.getElementById('profile-btn');
                        if (profileBtn) {
                            const nameSpan = profileBtn.querySelector('span');
                            if (nameSpan) {
                                nameSpan.textContent = `Hi, ${profile.displayName}`;
                            }
                        }
                        
                        // Update dropdown display name
                        const dropdownName = document.querySelector('#profile-dropdown h3');
                        if (dropdownName) {
                            dropdownName.textContent = profile.displayName;
                        }
                        
                    } catch (error) {
                        console.error('Error updating profile:', error);
                        alert('Failed to update username. Please try again.');
                    }
                }
            });
            
            appRoot.addEventListener('keydown', (e) => {
                if(e.target.id === 'chat-input' && e.key === 'Enter') {
                    e.preventDefault();
                    handleChatSend();
                }
                 if(e.target.id === 'note-input' && e.key === 'Enter') {
                    e.preventDefault();
                    handleAddNote();
                }
            });

            audio.addEventListener('play', () => {
                document.getElementById('play-icon')?.classList.add('hidden');
                document.getElementById('pause-icon')?.classList.remove('hidden');
            });
            audio.addEventListener('pause', () => {
                document.getElementById('play-icon')?.classList.remove('hidden');
                document.getElementById('pause-icon')?.classList.add('hidden');
            });
            audio.addEventListener('ended', playNextSong);
            
            // Close profile dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const profileBtn = document.getElementById('profile-btn');
                const dropdown = document.getElementById('profile-dropdown');
                const arrow = document.getElementById('profile-arrow');
                
                if (profileBtn && dropdown && arrow && 
                    !profileBtn.contains(e.target) && 
                    !dropdown.contains(e.target) &&
                    dropdown.classList.contains('opacity-100')) {
                    
                    dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
                    dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
                    arrow.style.transform = 'rotate(0deg)';
                }
            });
            // In your featureContainer event listeners, make sure you have this:
featureContainer.addEventListener('click', (e) => {
    const target = e.target;
    
    // Close about us modal - FIXED VERSION
    if (target.id === 'close-about-modal' || target.closest('#close-about-modal')) {
        const modal = document.getElementById('about-us-modal');
        if (modal) {
            const modalContent = modal.querySelector('.modal-content');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.remove(), 300);
        }
    }
    
    // Other event listeners...
});
            // Add event delegation for feature container (modals)
            featureContainer.addEventListener('click', (e) => {
                const target = e.target;
                
                // Close profile modal
                if (target.id === 'close-profile-modal') {
                    document.getElementById('profile-modal').remove();
                }
                
                // Close movie modal
                if (target.id === 'close-movie-modal') {
                    document.getElementById('movie-player-modal').remove();
                }
                
                // Close events modal
                if (target.id === 'close-events-modal') {
                    document.getElementById('events-modal').remove();
                }
                
                // Next video button
                if (target.id === 'next-video-btn') {
                    const iframe = document.getElementById('movie-iframe');
                    const randomVideoId = MOTIVATIONAL_VIDEOS[Math.floor(Math.random() * MOTIVATIONAL_VIDEOS.length)];
                    iframe.src = `https://www.youtube.com/embed/${randomVideoId}?enablejsapi=1&origin=${window.location.origin}`;
                }
                
                // Video category buttons
                if (target.classList.contains('video-category-btn')) {
                    const category = target.dataset.category;
                    const iframe = document.getElementById('movie-iframe');
                    const videos = VIDEO_GENRES[category] || MOTIVATIONAL_VIDEOS;
                    const randomVideoId = videos[Math.floor(Math.random() * videos.length)];
                    
                    iframe.src = `https://www.youtube.com/embed/${randomVideoId}?enablejsapi=1&origin=${window.location.origin}`;
                }
                
                // Video thumbnail buttons
                if (target.classList.contains('video-thumbnail-btn')) {
                    const videoId = target.dataset.videoId;
                    const iframe = document.getElementById('movie-iframe');
                    iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&origin=${window.location.origin}`;
                }
            });
        }
        
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if(user) drawInteractiveChart(chartData);
            }, 150);
        });

     function main() {
    // Initialize theme
    const savedTheme = localStorage.getItem('youthmind-theme');
    isDarkMode = savedTheme === 'dark';
    document.documentElement.classList.toggle('dark', isDarkMode);

    renderLoadingScreen();
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setPersistence(auth, browserLocalPersistence);
    } catch (e) {
        appRoot.innerHTML = `<div class="p-4 text-red-600">Firebase initialization failed. Check console for details.</div>`;
        console.error(e);
        return;
    }

    setupEventListeners();

    onAuthStateChanged(auth, async (u) => {
        if (chatUnsubscribe) chatUnsubscribe();
        if (u) {
            user = u;
            renderAppShell();
            renderAppContent(true);
            
            const userDoc = await getDoc(doc(db, `artifacts/${appId}/users/${u.uid}`));
            profile = userDoc.exists() ? { uid: u.uid, ...userDoc.data() } : { uid: u.uid, displayName: u.displayName || u.email?.split('@')[0] || "Friend" };

            const chatPath = `artifacts/${appId}/chats/${u.uid}/messages`;
            const q = query(collection(db, chatPath), orderBy("sentAt", "asc"));
            chatUnsubscribe = onSnapshot(q, (snap) => {
                chatMessages = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
                const chatInput = document.getElementById('chat-input');
                const isTyping = chatInput ? chatInput.disabled : false;
                updateChatMessages(chatMessages, isTyping, false);
            });

            await refreshMoodData(u.uid);
            renderAppContent(false);
            drawInteractiveChart(chartData);
            updateMusicCategoryFromMood();
            
            // Shuffle playlist on login to prepare for playback
            shuffledPlaylist = shuffleArray([...getCurrentPlaylist()]);
            currentTrackIndex = 0;

        } else {
            user = null;
            profile = null;
            renderAuthCard();
        }
    });
}
         // In your final app, you'll remove this and use your existing `isDarkMode` variable.
      

        const GEMINI_API_KEY = "AIzaSyDgHqrrTXR8apwWUxJSomJgw-BODNFoC-E"; // Your API Key
        const featureContainer = document.getElementById('feature-container');
        
       
        
        let quizPopupTimeout;
        let quizResultTimeout;

        // ===== 1. POPUP BANNER LOGIC =====
        function showQuizPopup() {
            const popupHTML = `
                <div id="quiz-popup-banner" class="quiz-popup fixed bottom-0 left-0 right-0 sm:bottom-5 sm:left-5 sm:right-auto sm:w-auto sm:max-w-md p-4 sm:rounded-lg shadow-2xl bg-white dark:bg-gray-800 border-t sm:border dark:border-gray-700 flex items-center justify-between pointer-events-auto">
                    <div>
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200">Quick Check-in?</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Take a moment to see how you're feeling.</p>
                    </div>
                    <button id="start-quiz-btn" class="ml-4 px-4 py-2 bg-indigo-600 dark:bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-700 dark:hover:bg-indigo-600 transition-colors flex-shrink-0">Start Quiz</button>
                </div>
            `;
            featureContainer.innerHTML = popupHTML;

            document.getElementById('start-quiz-btn').addEventListener('click', openQuizModal);
            
            quizPopupTimeout = setTimeout(() => {
                const banner = document.getElementById('quiz-popup-banner');
                if (banner) banner.remove();
            }, 15000);
        }

        // ===== 2. QUIZ MODAL LOGIC =====
        async function openQuizModal() {
            clearTimeout(quizPopupTimeout);
            const banner = document.getElementById('quiz-popup-banner');
            if (banner) banner.remove();

            featureContainer.innerHTML = `
                <div id="quiz-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 pointer-events-auto">
                    <div class="modal-content w-full max-w-lg bg-white dark:bg-gray-800 rounded-2xl shadow-xl flex flex-col max-h-[90vh]">
                        <div class="p-6 text-center">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Generating your check-in...</h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Just a moment!</p>
                            <div class="flex justify-center mt-4">
                                <div class="w-8 h-8 border-4 border-t-transparent border-indigo-500 rounded-full animate-spin"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const questions = await generateQuizQuestions();
                renderQuiz(questions);
            } catch (error) {
                console.error("Failed to generate quiz:", error);
                const modalContent = document.querySelector('.modal-content');
                if(modalContent) {
                    modalContent.innerHTML = `<div class="p-6 text-center"><h2 class="text-xl font-bold text-red-600 dark:text-red-400">Oops!</h2><p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Could not generate the quiz. Please try again later.</p><button id="close-modal-btn" class="mt-4 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg">Close</button></div>`;
                    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                }
            }
        }

        async function generateQuizQuestions() {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const prompt = "Generate 5 creative, funny, but insightful multiple-choice questions for a student's mental health check-in quiz. For each question, provide three options with corresponding scores: 2 for the most positive/healthy answer, 1 for a neutral answer, and 0 for a negative/unhealthy answer. Ensure questions are unique each time.";
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "quiz": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "question": { "type": "STRING" },
                                        "options": {
                                            type: "ARRAY",
                                            items: { type: "STRING" }
                                        },
                                        "scores": {
                                            type: "ARRAY",
                                            items: { type: "NUMBER" }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            };
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("API request failed");
            const result = await response.json();
            const jsonText = result.candidates[0].content.parts[0].text;
            return JSON.parse(jsonText).quiz;
        }

        function renderQuiz(questions) {
            const modalContent = document.querySelector('.modal-content');
            if (!modalContent) return;

            const questionsHTML = questions.map((q, index) => `
                <div class="mb-6">
                    <p class="font-semibold text-gray-800 dark:text-gray-200">${index + 1}. ${q.question}</p>
                    <div class="mt-3 space-y-2 custom-radio">
                        ${q.options.map((opt, i) => `
                            <div>
                                <input type="radio" id="q${index}_opt${i}" name="question_${index}" value="${q.scores[i]}" required>
                                <label for="q${index}_opt${i}" class="block w-full p-3 text-sm rounded-lg border-2 border-gray-200 dark:border-gray-600 hover:border-indigo-400 dark:hover:border-indigo-500 cursor-pointer text-gray-700 dark:text-gray-300">
                                    ${opt}
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            modalContent.innerHTML = `
                <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Mental State Check-in</h2>
                        <button id="close-modal-btn" class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">&times;</button>
                    </div>
                </div>
                <form id="quiz-form" class="p-6 overflow-y-auto">
                    ${questionsHTML}
                    <button type="submit" class="w-full mt-4 py-3 bg-indigo-600 dark:bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-700 dark:hover:bg-indigo-600 transition-colors">Submit Answers</button>
                </form>
            `;

            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('quiz-form').addEventListener('submit', handleQuizSubmit);
        }

        function handleQuizSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            let totalScore = 0;
            for (const value of formData.values()) {
                totalScore += parseInt(value, 10);
            }
            showQuizResults(totalScore);
        }

        function showQuizResults(score) {
            let title, message, recommendation;

            if (score <= 5) {
                title = "It's Okay to Need Support";
                message = "It seems like things might be a bit heavy right now, and that's completely okay. Reaching out is a sign of strength.";
                recommendation = renderCounselorSection(true); // true for modal version
            } else if (score >= 6 && score <= 8) {
                title = "You're Doing Great!";
                message = "You're navigating things well. Remember to keep taking time for yourself. A little self-care goes a long way!";
                recommendation = `<p class="mt-4 text-sm text-gray-600">Keep up the great work, champ!</p>`;
            } else {
                title = "You're Shining Bright! ‚ú®";
                message = "Amazing! You're rocking it. Keep embracing that positive energy and spreading the good vibes.";
                recommendation = `<p class="mt-4 text-sm text-gray-600">You're a true champion!</p>`;
            }

            const modalContent = document.querySelector('.modal-content');
            if (!modalContent) return;

               modalContent.innerHTML = `
                <div class="p-6 text-center flex flex-col max-h-[80vh]">
                    <div class="flex-shrink-0">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">${title}</h2>
                        <p class="mt-2 text-gray-700 dark:text-gray-300">Your Score: <span class="font-bold text-indigo-500">${score}/10</span></p>
                        <p class="mt-4 text-gray-600 dark:text-gray-400">${message}</p>
                    </div>
                    
                    <!-- This is the new scrollable container -->
                    <div class="mt-6 flex-grow overflow-y-auto p-1">
                        ${recommendation}
                    </div>

                     <button id="close-modal-btn" class="mt-6 px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg text-sm font-semibold flex-shrink-0">Close</button>
                </div>
            `;
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            quizResultTimeout = setTimeout(closeModal, 60000); // Auto-close after 1 minute
        }
        function detectStressFromChat() {
    const stressKeywords = ["stressed", "anxious", "overwhelmed", "panic", "nervous", "tense", "worried", "pressure"];
    const lastUserMessage = chatMessages.filter(m => m.sender === 'user').pop();
    
    if (lastUserMessage) {
        const message = lastUserMessage.text.toLowerCase();
        return stressKeywords.some(keyword => message.includes(keyword));
    }
    return false;
}

function showBreathingSuggestion() {
    const suggestionHTML = `
        <div id="breathing-suggestion" class="fixed bottom-4 right-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 border border-gray-200 dark:border-gray-700 max-w-xs pointer-events-auto animate-pulse">
            <div class="flex items-start">
                <div class="flex-shrink-0 text-2xl">üå¨Ô∏è</div>
                <div class="ml-3">
                    <h4 class="font-semibold text-gray-900 dark:text-gray-100">Feeling stressed?</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Take a moment for deep breathing to calm your mind.</p>
                    <div class="mt-2 flex gap-2">
                        <button id="accept-breathing-suggestion" class="px-3 py-1.5 bg-indigo-600 text-white text-xs font-semibold rounded-lg">Try It</button>
                        <button id="dismiss-breathing-suggestion" class="px-3 py-1.5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs font-semibold rounded-lg">Not Now</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove any existing suggestion
    const existingSuggestion = document.getElementById('breathing-suggestion');
    if (existingSuggestion) existingSuggestion.remove();
    
    // Add new suggestion
    featureContainer.insertAdjacentHTML('beforeend', suggestionHTML);
    
    // Add event listeners
    document.getElementById('accept-breathing-suggestion').addEventListener('click', () => {
        document.getElementById('breathing-suggestion').remove();
        renderBreathingModal();
    });
    
    document.getElementById('dismiss-breathing-suggestion').addEventListener('click', () => {
        document.getElementById('breathing-suggestion').remove();
    });
    
    // Auto-dismiss after 10 seconds
    setTimeout(() => {
        const suggestion = document.getElementById('breathing-suggestion');
        if (suggestion) suggestion.remove();
    }, 10000);
}
// Auto-delete functionality removed; manual delete remains via UI.
// You can call showBreathingSuggestion() when stress is detected in chat
        function closeModal() {
            clearTimeout(quizResultTimeout);
            const modal = document.getElementById('quiz-modal');
            if(modal) modal.remove();
        }
        // Manual delete ALL messages function
async function deleteAllChats() {
    if (!user) return;
    
    try {
        const chatPath = `artifacts/${appId}/chats/${user.uid}/messages`;
        
        // Query for ALL messages (no date filter)
        const q = query(collection(db, chatPath));
        
        const querySnapshot = await getDocs(q);
        const deletePromises = [];
        
        querySnapshot.forEach((doc) => {
            deletePromises.push(deleteDoc(doc.ref));
        });
        
        await Promise.all(deletePromises);
        
        if (deletePromises.length > 0) {
            console.log(`Manually deleted ${deletePromises.length} chat messages`);
            
            // Clear local chat messages array
            chatMessages = [];
            updateChatMessages(chatMessages, false, false);
            
            // Show notification
            showNotification(`Deleted all ${deletePromises.length} messages`);
        } else {
            showNotification("No messages to delete");
        }
    } catch (error) {
        console.error("Error deleting all chats:", error);
        showNotification("Error deleting messages", true);
    }
}
// Helper function to show notifications
function showNotification(message, isError = false) {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 ${
        isError ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' 
                : 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'
    } px-4 py-2 rounded-lg shadow-lg text-sm transition-all duration-300 transform translate-y-10 opacity-0 z-50`;
    
    notification.innerHTML = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.remove('translate-y-10', 'opacity-0');
        notification.classList.add('translate-y-0', 'opacity-100');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('translate-y-0', 'opacity-100');
        notification.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
        // ===== INITIALIZATION =====
        // Show the popup 1 second after the page loads
        setTimeout(showQuizPopup, 4000);

        main();
    </script>
</body>
</html>
